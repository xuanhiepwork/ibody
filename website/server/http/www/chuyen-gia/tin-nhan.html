<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tin nhắn - Chuyên gia</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    :root {
      --primary-color: #A993EC;
      --primary-color-light: rgba(169, 147, 236, 0.1);
      --sidebar-bg: #ffffff;
      --main-bg: #f8f7fc;
      --card-bg: #ffffff;
      --border-color: #eef0f4;
      --text-primary: #1a202c;
      --text-secondary: #718096;
      --chat-bubble-sent-bg: var(--primary-color);
      --chat-bubble-received-bg: #f1f5f9;
      --sidebar-width: 260px;
      --sidebar-width-collapsed: 80px;
    }

    body.dark-mode {
      --primary-color-light: rgba(169, 147, 236, 0.15);
      --sidebar-bg: #1f2937;
      --main-bg: #111827;
      --card-bg: #1f2937;
      --border-color: #374151;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --chat-bubble-received-bg: #374151;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background-color: var(--main-bg); color: var(--text-primary); overflow: hidden; }
    
    /* --- Layout chung --- */
    .topbar { position: fixed; top: 0; left: 0; right: 0; height: 60px; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1001; }
    .topbar-left { display: flex; align-items: center; gap: 15px; }
    #toggleSidebarBtn, #toggleThemeBtn { background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; transition: color 0.2s; }
    #toggleSidebarBtn:hover, #toggleThemeBtn:hover { color: var(--primary-color); }
    .topbar-title { font-weight: 600; color: var(--primary-color); }
    
    .sidebar { position: fixed; top: 60px; left: 0; width: var(--sidebar-width); height: calc(100vh - 60px); background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); padding: 20px 15px; display: flex; flex-direction: column; transition: width 0.3s ease; z-index: 1000; }
    .sidebar.collapsed { width: var(--sidebar-width-collapsed); }
    .sidebar a { display: flex; align-items: center; gap: 15px; padding: 12px; text-decoration: none; color: var(--text-secondary); border-radius: 8px; font-weight: 500; white-space: nowrap; }
    .sidebar a .fa-solid { font-size: 1.2rem; width: 28px; text-align: center; }
    .sidebar a:hover { background-color: var(--main-bg); color: var(--text-primary); }
    .sidebar a.active { background-color: var(--primary-color); color: white; }
    .sidebar a.logout { margin-top: auto; color: #dc3545; }
    .sidebar.collapsed a .link-text { display: none; }
    
    .main-content { margin-top: 60px; margin-left: var(--sidebar-width); height: calc(100vh - 60px); padding: 0; transition: margin-left 0.3s ease; }
    .main-content.collapsed { margin-left: var(--sidebar-width-collapsed); }
    
    /* --- Chat Layout --- */
    .chat-container { display: flex; height: 100%; }
    .chat-sidebar {
        width: 320px;
        min-width: 320px;
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        background-color: var(--card-bg);
        transition: transform 0.3s ease, min-width 0.3s ease, width 0.3s ease;
    }
    .chat-sidebar-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
    .chat-sidebar-header h2 { font-size: 1.5rem; margin: 0; }
    .search-wrapper { padding: 10px 20px; }
    #chatSearchInput { width: 100%; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 20px; background-color: var(--main-bg); color: var(--text-primary); }
    .chat-list { flex-grow: 1; overflow-y: auto; }
    .chat-list-item { display: flex; align-items: center; gap: 15px; padding: 15px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
    .chat-list-item:hover { background-color: var(--main-bg); }
    .chat-list-item.active { background-color: var(--primary-color-light); }
    .chat-list-item img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
    .chat-info { flex-grow: 1; overflow: hidden; }
    .chat-info-header { display: flex; justify-content: space-between; align-items: center; }
    .chat-info .name { font-weight: 600; }
    .chat-info .timestamp { font-size: 0.8rem; color: var(--text-secondary); }
    .last-message-wrapper { display: flex; justify-content: space-between; align-items: center; }
    .last-message-wrapper .last-message { flex-grow: 1; font-size: 0.9rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .unread-indicator { width: 18px; height: 18px; background-color: var(--primary-color); border-radius: 50%; color: white; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; font-weight: 600; }

    .chat-area { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--main-bg); }
    .chat-header { display: flex; align-items: center; gap: 15px; padding: 10px 20px; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); }
    .chat-header img { width: 40px; height: 40px; border-radius: 50%; }
    .chat-header .name { font-weight: 600; font-size: 1.1rem; }
    .chat-header .status { font-size: 0.8rem; color: #28a745; }
    .chat-header .actions { margin-left: auto; display: flex; gap: 15px; font-size: 1.2rem; }
    .chat-header .back-btn { display: none; }
    
    .messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 2px; }
    .message-item { display: flex; flex-direction: column; }
    .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; line-height: 1.5; margin-top: 10px;}
    .message-bubble.sent { background-color: var(--chat-bubble-sent-bg); color: white; border-bottom-right-radius: 4px; align-self: flex-end; }
    .message-bubble.received { background-color: var(--chat-bubble-received-bg); color: var(--text-primary); border-bottom-left-radius: 4px; align-self: flex-start; }
    
    .date-separator { align-self: center; color: var(--text-secondary); background-color: var(--border-color); font-size: 0.8rem; font-weight: 600; padding: 2px 10px; border-radius: 20px; margin: 15px 0; }
    .seen-indicator { display: flex; justify-content: flex-end; align-items: center; gap: 5px; font-size: 0.8rem; color: var(--text-secondary); padding-right: 5px; height: 20px; }
    .seen-indicator img { width: 16px; height: 16px; border-radius: 50%; }
    @keyframes bubble-in { from { transform: scale(0.8) translateY(10px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
    .message-bubble.newly-sent { animation: bubble-in 0.3s ease; }

    .chat-footer { display: flex; align-items: center; gap: 10px; padding: 10px 20px; background-color: var(--card-bg); border-top: 1px solid var(--border-color); }
    .chat-footer .icon-btn { font-size: 1.2rem; color: var(--text-secondary); cursor: pointer; background: none; border: none; padding: 8px; }
    #message-input { flex-grow: 1; border: none; background: transparent; padding: 12px; font-size: 1rem; color: var(--text-primary); }
    #message-input:focus { outline: none; }
    
    .welcome-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); text-align: center; }
    .welcome-screen i { font-size: 4rem; margin-bottom: 20px; color: var(--primary-color); }

    /* Responsive */
    @media (max-width: 900px) {
        .chat-container.chat-area-visible .chat-sidebar { transform: translateX(-100%); min-width: 0; width: 0; padding: 0; border: none;}
        .chat-header .back-btn { display: block; }
    }
    
    /* Gọi điện */
    .call-action-btn {
        display: inline-flex; /* Giúp icon và chữ nằm cạnh nhau */
        align-items: center;
        gap: 8px; /* Khoảng cách giữa icon và chữ */

        background-color: var(--primary-color); /* Sử dụng màu tím chủ đạo */
        color: white;

        padding: 10px 20px;
        border-radius: 50px; /* Bo tròn hoàn toàn */

        font-weight: 600;
        font-size: 1rem;
        text-decoration: none;

        border: none;
        cursor: pointer;

        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(169, 147, 236, 0.4);
    }

    .call-action-btn:hover {
        background-color: var(--secondary-color); /* Màu tím đậm hơn khi hover */
        transform: translateY(-2px); /* Hiệu ứng nâng lên */
        box-shadow: 0 6px 20px rgba(169, 147, 236, 0.5);
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="topbar-left">
      <button id="toggleSidebarBtn" title="Ẩn/Hiện menu"><i class="fa-solid fa-bars"></i></button>
      <span class="topbar-title">IBODY - Chuyên gia</span>
    </div>
    <button id="toggleThemeBtn" title="Đổi giao diện"><i class="fas fa-moon"></i></button>
  </div>

  <div class="sidebar" id="sidebar">
    <a href="/chuyen-gia/"><i class="fa-solid fa-house"></i><span class="link-text">Trang chủ</span></a>
    <a href="./TongHopChuyenGia.html"><i class="fa-solid fa-chart-line"></i><span class="link-text">Quản lý thống kê</span></a>
    <a href="./appointments-expert.html"><i class="fa-solid fa-calendar-check"></i><span class="link-text">Lịch hẹn</span></a>
    <a href="./clients-expert.html"><i class="fa-solid fa-users"></i><span class="link-text">Khách hàng</span></a>
    <a href="#" class="active"><i class="fa-solid fa-comments"></i><span class="link-text">Tin nhắn</span></a>
    <a href="/profile"><i class="fa-solid fa-user-circle"></i><span class="link-text">Hồ sơ cá nhân</span></a>
    <a href="./yeuCauLuong.html"><i class="fa-solid fa-hand-holding-dollar"></i><span class="link-text">Yêu cầu nhận lương</span></a>
    <a href="./lichSuLuong.html"><i class="fa-solid fa-clock-rotate-left"></i><span class="link-text">Lịch sử nhận lương</span></a>
    <a href="#" class="logout"><i class="fa-solid fa-arrow-right-from-bracket"></i><span class="link-text">Đăng xuất</span></a>
  </div>

  <div class="main-content" id="mainContent">
    <div class="chat-container" id="chatContainer">
      <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-sidebar-header">
            <h2>Tin nhắn</h2>
        </div>
        <div class="search-wrapper">
            <input type="text" id="chatSearchInput" placeholder="Tìm kiếm cuộc trò chuyện...">
        </div>
        <div class="chat-list" id="chatList"></div>
      </div>
      <div class="chat-area" id="chatArea"></div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const today = new Date('2025-06-08T11:00:00'); // Giả lập ngày hôm nay
    const yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);

    const mockConversations = [
        { id: 1, clientName: 'Nguyễn Thu An', clientAvatar: 'https://i.pravatar.cc/150?u=client1', lastMessage: 'Cảm ơn chuyên gia rất nhiều ạ!', timestamp: '10:30', unreadCount: 0, lastMessageSeenByClient: true },
        { id: 2, clientName: 'Trần Văn Bình', clientAvatar: 'https://i.pravatar.cc/150?u=client2', lastMessage: 'Chuyên gia ơi, tôi có thể hỏi thêm...', timestamp: 'Hôm qua', unreadCount: 2, lastMessageSeenByClient: false },
        { id: 3, clientName: 'Lê Thị Cẩm', clientAvatar: 'https://i.pravatar.cc/150?u=client3', lastMessage: 'Bạn: Lịch hẹn của bạn đã được xác nhận.', timestamp: 'Thứ 4', unreadCount: 0, lastMessageSeenByClient: true },
    ];

    const mockMessages = {
        1: [
            { sender: 'client', text: 'Chào chuyên gia, tôi đã sẵn sàng cho buổi tư vấn.', timestamp: new Date(new Date(today).setDate(today.getDate() - 1)) }, // Hôm qua
            { sender: 'expert', text: 'Chào bạn, rất vui được gặp bạn. Chúng ta bắt đầu nhé?', timestamp: new Date(new Date(today).setDate(today.getDate() - 1)) },
            { sender: 'client', text: 'Vâng ạ.', timestamp: new Date(new Date(today).setHours(9, 30, 0)) }, // Hôm nay
            { sender: 'expert', text: 'Cảm ơn bạn đã chia sẻ. Buổi hôm nay rất hiệu quả.', timestamp: new Date(new Date(today).setHours(10, 29, 0)) },
            { sender: 'client', text: 'Cảm ơn chuyên gia rất nhiều ạ!', timestamp: new Date(new Date(today).setHours(10, 30, 0)) },
        ],
        2: [
            { sender: 'client', text: 'Chuyên gia ơi, tôi có thể hỏi thêm một vài điều về buổi tư vấn trước được không ạ?', timestamp: yesterday },
        ],
        3: [
             { sender: 'expert', text: 'Lịch hẹn của bạn đã được xác nhận.', timestamp: new Date('2025-06-04T11:00:00') },
        ]
    };

    const chatList = document.getElementById('chatList');
    const chatArea = document.getElementById('chatArea');
    const chatContainer = document.getElementById('chatContainer');
    let messageListEl = null;

    // --- Helper Functions ---
    function scrollToBottom() {
        if(messageListEl) {
            messageListEl.scrollTo({ top: messageListEl.scrollHeight, behavior: 'smooth' });
        }
    }
    
    function formatDateSeparator(date) {
        const todaySep = new Date();
        const yesterdaySep = new Date();
        yesterdaySep.setDate(todaySep.getDate() - 1);

        if (date.toDateString() === todaySep.toDateString()) return 'Hôm nay';
        if (date.toDateString() === yesterdaySep.toDateString()) return 'Hôm qua';
        return date.toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'long' });
    }

    // --- Render Functions ---
    function renderConversations() {
        chatList.innerHTML = '';
        mockConversations.forEach(convo => {
            const item = document.createElement('div');
            item.className = 'chat-list-item';
            item.dataset.id = convo.id;
            item.innerHTML = `
                <img src="${convo.clientAvatar}" alt="Avatar">
                <div class="chat-info">
                    <div class="chat-info-header">
                        <span class="name">${convo.clientName}</span>
                        <span class="timestamp">${convo.timestamp}</span>
                    </div>
                    <div class="last-message-wrapper">
                      <span class="last-message">${convo.lastMessage}</span>
                      ${convo.unreadCount > 0 ? `<div class="unread-indicator">${convo.unreadCount}</div>` : ''}
                    </div>
                </div>
            `;
            chatList.appendChild(item);
        });
    }
    
    function renderChatWindow(convoId) {
        const conversation = mockConversations.find(c => c.id === convoId);
        const messages = mockMessages[convoId] || [];
        
        chatArea.innerHTML = `
            <div class="chat-header">
                <button class="icon-btn back-btn" id="backBtn"><i class="fas fa-arrow-left"></i></button>
                <img src="${conversation.clientAvatar}" alt="Avatar">
                <div>
                    <div class="name">${conversation.clientName}</div>
                    <div class="status">Đang hoạt động</div>
                </div>
                <div class="actions">
                    <a href="../videoCall.html" class="call-action-btn" title="Gọi điện">
                        <i class="fas fa-video"></i>
                        <span>Gọi điện</span>
                    </a>
                </div>
            </div>
            <ul class="messages" id="messageList"></ul>
            <div class="chat-footer">
                <button class="icon-btn"><i class="fas fa-paperclip"></i></button>
                <button class="icon-btn"><i class="far fa-smile"></i></button>
                <input type="text" id="message-input" placeholder="Nhập tin nhắn...">
                <button class="icon-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>`;
        
        messageListEl = document.getElementById('messageList');
        
        let lastDate = null;
        messages.forEach(msg => {
            const msgDate = new Date(msg.timestamp);
            if (!lastDate || msgDate.toDateString() !== lastDate.toDateString()) {
                const dateSeparator = document.createElement('div');
                dateSeparator.className = 'date-separator';
                dateSeparator.textContent = formatDateSeparator(msgDate);
                messageListEl.appendChild(dateSeparator);
                lastDate = msgDate;
            }
            const bubble = document.createElement('li');
            bubble.className = `message-bubble ${msg.sender === 'expert' ? 'sent' : 'received'}`;
            bubble.textContent = msg.text;
            messageListEl.appendChild(bubble);
        });

        const lastMessage = messages[messages.length - 1];
        if (conversation.lastMessageSeenByClient && lastMessage && lastMessage.sender === 'expert') {
            const seenIndicator = document.createElement('div');
            seenIndicator.className = 'seen-indicator';
            seenIndicator.innerHTML = `<span>Đã xem</span> <img src="${conversation.clientAvatar}" alt="seen">`;
            messageListEl.appendChild(seenIndicator);
        }

        scrollToBottom();

        document.getElementById('backBtn').addEventListener('click', () => chatContainer.classList.remove('chat-area-visible'));
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('sendBtn');

        function sendMessage() {
            const text = messageInput.value.trim();
            if (text === '') return;

            const newMessage = { sender: 'expert', text, timestamp: new Date() };
            messages.push(newMessage);
            
            const bubble = document.createElement('li');
            bubble.className = 'message-bubble sent newly-sent';
            bubble.textContent = newMessage.text;
            
            // Xóa chỉ báo "Đã xem" cũ nếu có
            const existingSeenIndicator = messageListEl.querySelector('.seen-indicator');
            if(existingSeenIndicator) existingSeenIndicator.remove();
            
            messageListEl.appendChild(bubble);

            messageInput.value = '';
            messageInput.focus();
            scrollToBottom();
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }
    
    function showWelcomeScreen() {
        chatArea.innerHTML = `
            <div class="welcome-screen">
                <i class="fas fa-comments"></i>
                <h2>Chào mừng đến với IBODY!</h2>
                <p>Chọn một cuộc trò chuyện để bắt đầu.</p>
            </div>
        `;
    }

    chatList.addEventListener('click', function(e) {
        const targetItem = e.target.closest('.chat-list-item');
        if (targetItem) {
            const convoId = parseInt(targetItem.dataset.id);
            document.querySelectorAll('.chat-list-item').forEach(item => item.classList.remove('active'));
            targetItem.classList.add('active');
            renderChatWindow(convoId);
            chatContainer.classList.add('chat-area-visible');
        }
    });

    // --- Sidebar & Theme Toggle Logic ---
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
    const toggleThemeBtn = document.getElementById('toggleThemeBtn');
    const body = document.body;
    toggleSidebarBtn.addEventListener('click', () => { sidebar.classList.toggle('collapsed'); mainContent.classList.toggle('collapsed'); });
    function setIconForTheme(theme) { toggleThemeBtn.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; }
    const savedTheme = localStorage.getItem('theme') || 'light';
    body.classList.add(savedTheme + '-mode');
    setIconForTheme(savedTheme);
    toggleThemeBtn.addEventListener('click', () => {
        body.classList.toggle('dark-mode');
        const currentTheme = body.classList.contains('dark-mode') ? 'dark' : 'light';
        localStorage.setItem('theme', currentTheme);
        setIconForTheme(currentTheme);
    });

    // --- Initial Render ---
    renderConversations();
    showWelcomeScreen();
});
</script>
</body>
</html>