document.addEventListener('DOMContentLoaded', () => {
  let chuyenGiaId = null;
  let scheduleData = [];

  const user = JSON.parse(localStorage.getItem("user"));
  if (!user) {
    alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.");
    window.location.href = "../index.html";
    return;
  }

    document.getElementById('editProfileBtn').addEventListener('click', () => {
    document.getElementById('edit-profile-modal').style.display = 'block';
  });
    // ƒê√≥ng modal khi click ngo√†i modal (tu·ª≥ ch·ªçn)
  window.addEventListener('click', e => {
    const modal = document.getElementById('edit-profile-modal');
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });

  // === Modal xem ·∫£nh ch·ª©ng ch·ªâ ===
  const certModal = document.getElementById('certModal');
  const certModalImg = document.getElementById('certModalImg');
  const viewCertBtn = document.getElementById('viewCertBtn');

  viewCertBtn.addEventListener('click', () => {
    fetch(`http://localhost:5221/api/chuyen-gia/thongTin/${user.taiKhoanId}`)
      .then(res => res.json())
      .then(data => {
        if (data.anhChungChi) {
          certModalImg.src = `http://localhost:5221${data.anhChungChi}`;
          certModal.style.display = 'flex';
        } else {
          alert("Ch∆∞a c√≥ ·∫£nh ch·ª©ng ch·ªâ.");
        }
      });
  });

  certModal.addEventListener('click', e => {
    if (e.target === certModal || e.target === certModalImg) {
      certModal.style.display = 'none';
      certModalImg.src = '';
    }
  });

  // === Load l·ªãch r·∫£nh ===
function loadSchedule() {
  console.log("B·∫Øt ƒë·∫ßu load l·ªãch...");
  if (!chuyenGiaId) {
    console.warn("Ch∆∞a c√≥ chuyenGiaId");
    return;
  }
  fetch(`http://localhost:5221/api/thoi-gian-ranh/chuyen-gia/${chuyenGiaId}`)
    .then(res => res.json())
    .then(data => {
      console.log("D·ªØ li·ªáu l·ªãch r·∫£nh nh·∫≠n ƒë∆∞·ª£c:", data);
      scheduleData = data;

      const tbody = document.querySelector("#scheduleTable tbody");
      console.log("tbody t√¨m ƒë∆∞·ª£c:", tbody);

      tbody.innerHTML = "";
      data.forEach(item => {
        console.log("ƒêang th√™m d√≤ng l·ªãch:", item);
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${thuToText(item.thuTrongTuan)}</td>
          <td>${item.tu}</td>
          <td>${item.den}</td>
          <td>
            <button onclick="editSchedule(${item.id})">‚úèÔ∏è</button>
            <button onclick="deleteSchedule(${item.id})">üóëÔ∏è</button>
          </td>`;
        tbody.appendChild(row);
      });
    })
    .catch(err => console.error("L·ªói load l·ªãch:", err));
}


  // === L·∫•y v√† hi·ªÉn th·ªã th√¥ng tin chuy√™n gia ===
  fetch(`http://localhost:5221/api/chuyen-gia/thongTin/${user.taiKhoanId}`)
    .then(res => res.json())
    .then(data => {
      chuyenGiaId = data.id;

      document.getElementById('currentAvatar').src = data.avatarUrl ? `http://localhost:5221${data.avatarUrl}` : "../images/user.png";
      document.getElementById('cgFullName').textContent = data.hoTen;
      document.getElementById('cgSpecialty').textContent = data.chuyenMon;
      document.getElementById('cgExperience').textContent = data.soNamKinhNghiem;
      document.getElementById('cgCertificates').textContent = data.soChungChi;
      document.getElementById('cgIntro').textContent = data.gioiThieu || "";
      document.getElementById('cgSoTaiKhoan').textContent = data.soTaiKhoan || "Ch∆∞a c·∫≠p nh·∫≠t";
      document.getElementById('cgTenNganHang').textContent = data.tenNganHang || "Ch∆∞a c·∫≠p nh·∫≠t";


      // ƒêi·ªÅn form ch·ªânh s·ª≠a
      document.getElementById('editFullName').value = data.hoTen || "";
      document.getElementById('editSpecialty').value = data.chuyenMon || "";
      document.getElementById('editExperience').value = data.soNamKinhNghiem || "";
      document.getElementById('editCertificates').value = data.soChungChi || "";
      document.getElementById('editIntro').value = data.gioiThieu || "";
      document.getElementById('editSoTaiKhoan').value = data.soTaiKhoan || "";
      document.getElementById('editTenNganHang').value = data.tenNganHang || "";

      // Load l·ªãch r·∫£nh sau khi c√≥ chuyenGiaId
      loadSchedule();
    });

  // === Form ch·ªânh s·ª≠a h·ªì s∆° ===
  document.getElementById('editForm').addEventListener('submit', async e => {
  e.preventDefault();
  if (!chuyenGiaId) return alert("Kh√¥ng c√≥ ID chuy√™n gia.");

  // X·ª≠ l√Ω upload ·∫£nh ƒë·∫°i di·ªán n·∫øu c√≥
  const file = document.getElementById("avatarInput").files[0];
  if (file) {
    await uploadAvatar();
  }

  const payload = {
    hoTen: document.getElementById('editFullName').value,
    chuyenMon: document.getElementById('editSpecialty').value,
    soNamKinhNghiem: parseInt(document.getElementById('editExperience').value),
    gioiThieu: document.getElementById('editIntro').value,
    soChungChi: document.getElementById('editCertificates').value,
    soTaiKhoan: document.getElementById('editSoTaiKhoan').value || 'Ch∆∞a c·∫≠p nh·∫≠t',
    tenNganHang: document.getElementById('editTenNganHang').value || 'Ch∆∞a c·∫≠p nh·∫≠t',
    // Kh√¥ng g·ª≠i ·∫£nh ch·ª©ng ch·ªâ n·ªØa
    // anhChungChi: document.getElementById('editCertificates').value ? '' : undefined
  };

  console.log("Payload g·ª≠i ƒëi:", payload);

  const res = await fetch(`http://localhost:5221/api/chuyen-gia/cap-nhat/${chuyenGiaId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const result = await res.json();
  if (res.ok) {
    alert("‚úÖ ƒê√£ l∆∞u thay ƒë·ªïi.");
    document.getElementById('cgFullName').textContent = payload.hoTen;
    document.getElementById('cgSpecialty').textContent = payload.chuyenMon;
    document.getElementById('cgExperience').textContent = payload.soNamKinhNghiem;
    document.getElementById('cgCertificates').textContent = payload.soChungChi;
    document.getElementById('cgIntro').textContent = payload.gioiThieu;
    document.getElementById('cgSoTaiKhoan').textContent = payload.soTaiKhoan;
    document.getElementById('cgTenNganHang').textContent = payload.tenNganHang;

    // ·∫®n modal sau khi l∆∞u
    document.getElementById('edit-profile-modal').style.display = 'none';
  } else {
    alert(`‚ùå L·ªói: ${result.message || "Kh√¥ng x√°c ƒë·ªãnh"}`);
  }
});


  // === H√†m ch·ªânh s·ª≠a l·ªãch (ƒë∆∞·ª£c g·ªçi t·ª´ HTML) ===
  window.editSchedule = function (id) {
    const item = scheduleData.find(s => s.id === id);
    if (item) {
      document.getElementById('scheduleId').value = item.id;
      document.getElementById('thuTrongTuan').value = item.thuTrongTuan;
      document.getElementById('tu').value = item.tu;
      document.getElementById('den').value = item.den;
    }
  };

  // === H√†m xo√° l·ªãch (ƒë∆∞·ª£c g·ªçi t·ª´ HTML) ===
  window.deleteSchedule = async function (id) {
    if (confirm("X√°c nh·∫≠n xo√°?")) {
      await fetch(`http://localhost:5221/api/thoi-gian-ranh/${id}`, { method: 'DELETE' });
      loadSchedule();
      document.getElementById('scheduleForm').reset();
      document.getElementById('scheduleId').value = "";
    }
  };

  // === Form th√™m/s·ª≠a l·ªãch r·∫£nh ===
  document.getElementById('scheduleForm').addEventListener('submit', async e => {
    e.preventDefault();

    const id = document.getElementById('scheduleId').value;
    const thu = parseInt(document.getElementById('thuTrongTuan').value);
    const tu = document.getElementById('tu').value;
    const den = document.getElementById('den').value;

    function isConflictWithSavedSchedule(thuMoi, tuMoi, denMoi, idDangSua = null) {
      return scheduleData.some(item => {
        if (idDangSua && item.id == idDangSua) return false;
        return item.thuTrongTuan == thuMoi && !(denMoi <= item.tu || tuMoi >= item.den);
      });
    }

    // Ki·ªÉm tra tr√πng l·ªãch
    const isConflict = scheduleData.some(item => {
      if (id && item.id == id) return false;
      return item.thuTrongTuan == thu && !(den <= item.tu || tu >= item.den);
    });

    if (isConflict) {
      alert("Khung gi·ªù b·ªã tr√πng v·ªõi l·ªãch r·∫£nh ƒë√£ c√≥.");
      return;
    }

    if (isConflictWithSavedSchedule(thu, tu, den, id)) {
      alert("‚ö†Ô∏è Khung gi·ªù b·ªã tr√πng v·ªõi l·ªãch ƒë√£ l∆∞u tr∆∞·ªõc ƒë√≥. H√£y ch·ªçn khung gi·ªù kh√°c.");
      return;
    }

    const payload = { chuyenGiaId, thuTrongTuan: thu, tu, den };
    const url = id
      ? `http://localhost:5221/api/thoi-gian-ranh/${id}`
      : `http://localhost:5221/api/thoi-gian-ranh`;
    const method = id ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const result = await res.json();
      alert(result.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh.");
      return;
    }

    document.getElementById('scheduleForm').reset();
    document.getElementById('scheduleId').value = "";
    loadSchedule();
  });

  // === H√†m t·∫£i ·∫£nh ƒë·∫°i di·ªán ===
  async function uploadAvatar() {
    const user = JSON.parse(localStorage.getItem("user"));
    const file = document.getElementById("avatarInput").files[0];
    if (!file) {
      alert("Vui l√≤ng ch·ªçn ·∫£nh.");
      return;
    }
    const formData = new FormData();
    formData.append("file", file);
    try {
      const res = await fetch(`http://localhost:5221/api/chuyen-gia/upload-avatar/${user.taiKhoanId}`, {
        method: "POST",
        body: formData
      });
      const result = await res.json();
      if (!res.ok) throw new Error(result.message || "L·ªói khi t·∫£i ·∫£nh");
      alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán!");
      document.getElementById("currentAvatar").src = `http://localhost:5221${result.avatarUrl}`;
    } catch (err) {
      alert("‚ùå " + err.message);
    }
  }

  // === H√†m chuy·ªÉn th·ª© sang ch·ªØ ===
  function thuToText(thu) {
    const mapping = {
      0: "Ch·ªß nh·∫≠t",
      1: "Th·ª© 2",
      2: "Th·ª© 3",
      3: "Th·ª© 4",
      4: "Th·ª© 5",
      5: "Th·ª© 6",
      6: "Th·ª© 7"
    };
    return mapping[thu] || `Th·ª© ${thu}`;
  }

  // === ƒêƒÉng xu·∫•t ===
  window.logout = function () {
    localStorage.removeItem("user");
    alert("ƒêƒÉng xu·∫•t th√†nh c√¥ng!");
    window.location.href = "../index.html";
  };
});


document.getElementById("toggleSidebarBtn").onclick = () => {
  document.getElementById("sidebar").classList.toggle("collapsed");
  document.getElementById("sidebar").classList.toggle("expanded");
  document.getElementById("mainContent").classList.toggle("collapsed");
  document.getElementById("mainContent").classList.toggle("expanded");
};

document.getElementById("toggleThemeBtn").onclick = () => {
  document.body.classList.toggle("dark-mode");
  document.getElementById("toggleThemeBtn").textContent =
    document.body.classList.contains("dark-mode") ? "‚òÄÔ∏è" : "üåô";
};